import{_ as s,c as i,o as a,a4 as n}from"./chunks/framework.BG61BEI0.js";const y=JSON.parse('{"title":"经典框架源码面试题","description":"","frontmatter":{},"headers":[],"relativePath":"01-Dev/01.98-八股/经典框架源码面试题.md","filePath":"01-Dev/01.98-八股/经典框架源码面试题.md"}'),t={name:"01-Dev/01.98-八股/经典框架源码面试题.md"},l=n(`<h1 id="经典框架源码面试题" tabindex="-1">经典框架源码面试题 <a class="header-anchor" href="#经典框架源码面试题" aria-label="Permalink to &quot;经典框架源码面试题&quot;">​</a></h1><h1 id="_1-谈谈你对框架的理解" tabindex="-1">1.谈谈你对框架的理解 <a class="header-anchor" href="#_1-谈谈你对框架的理解" aria-label="Permalink to &quot;1.谈谈你对框架的理解&quot;">​</a></h1><h2 id="_1-1-框架的作用" tabindex="-1">1.1 框架的作用 <a class="header-anchor" href="#_1-1-框架的作用" aria-label="Permalink to &quot;1.1 框架的作用&quot;">​</a></h2><p>JavaWeb中的框架是一种开发工具或者平台，它提供了一系列的功能和组件，用于简化和加速Web应用的开发过程。框架可以提供一些基础设施，如数据库访问、用户认证和授权、日志记录等，以及一些高级功能，如MVC模式、依赖注入、AOP等。</p><p>对于我来说，JavaWEB中的框架是一个可重用的代码库，它提供了一些现成的解决方案，可以帮助开发人员更快地构建稳定、高效的应用程序。框架可以帮助我们遵循最佳实践，减少重复劳动，提高代码的可维护性和可扩展性。同时，框架还可以提供一些标准化的API和约定，使得不同开发人员之间更容易合作和交流。通过使用框架，我们可以更专注于业务逻辑的实现，而不需要过多地关注底层的技术细节。</p><h2 id="_1-2-常见用框架有哪些" tabindex="-1">1.2 常见用框架有哪些 <a class="header-anchor" href="#_1-2-常见用框架有哪些" aria-label="Permalink to &quot;1.2 常见用框架有哪些&quot;">​</a></h2><p>列举常用的开源框架及作用：</p><ul><li>Spring：提供了一个轻量级的容器，用于管理对象之间的依赖关系</li><li>SpringMVC：提供了一个MVC模式的实现，用于处理用户请求和生成响应</li><li>SpringBoot：基于Spring的脚手架工具。更进一步简化了项目的构建过程和依赖管理</li><li>MyBatis：经典的ORM框架，现在使用更多的是MyBatisPlus</li><li>SpringSecurity：基于Spring容器的一个权限管理框架</li><li>Shiro：Apache提供的一个权限管理框架。相比SpringSecurity更轻量</li><li>SpringCloud：是一个基于Spring Boot的开发工具包，用于构建分布式系统的微服务架构。它提供了一系列的开发工具和库，帮助开发者快速构建、部署和扩展分布式系统。</li><li>Redis：是一个开源的内存数据结构存储系统，可以用作数据库、缓存和消息中间件。它支持多种数据结构。</li><li>Dubbo：是一种高性能、轻量级的开源分布式服务框架，由阿里巴巴集团开源。它提供了服务治理、负载均衡、容错、可视化运维等功能，能够帮助开发者快速构建可扩展的分布式应用。</li><li>....</li></ul><h1 id="_2-spring的轻量体现在哪些方面" tabindex="-1">2.Spring的轻量体现在哪些方面？ <a class="header-anchor" href="#_2-spring的轻量体现在哪些方面" aria-label="Permalink to &quot;2.Spring的轻量体现在哪些方面？&quot;">​</a></h1><p>Spring框架之所以被称为轻量级的框架，体现在以下几个方面：</p><ol><li>配置简单：Spring使用基于XML或注解的配置方式，使得配置文件简洁明了。相比其他框架，Spring的配置文件通常更加简单和易于维护。</li><li>无侵入性：Spring框架的设计理念是非侵入式的，即应用程序的代码不需要继承框架特定的类或实现特定的接口。这使得开发者可以更加自由地编写业务逻辑，减少对框架的依赖。</li><li>松耦合：Spring框架通过控制反转（IoC）和依赖注入（DI）来实现松耦合的设计。通过IoC容器管理对象的生命周期和依赖关系，使得对象之间的耦合度降低，提高了代码的可维护性和可测试性。</li><li>模块化：Spring框架提供了丰富的模块化功能，开发者可以根据项目需要选择使用相应的模块，减少了不必要的开销。同时，Spring框架的模块之间也是相互独立的，可以根据具体需求进行组合和扩展。</li><li>高度可扩展：Spring框架的设计非常灵活，提供了大量的扩展接口和插件机制，开发者可以根据自己的需求进行定制和扩展。同时，Spring也与其他流行的开源框架和技术（如Hibernate、MyBatis、JUnit等）紧密集成，使得开发者可以更加方便地使用这些工具和技术。</li></ol><p>总的来说，Spring框架的轻量级体现在其简单的配置、非侵入式的设计、松耦合的架构、模块化的功能和高度可扩展的特性上，使得开发者可以更加轻松地开发和维护应用程序。</p><h1 id="_3-spring中是如何管理对象的依赖关系的" tabindex="-1">3.Spring中是如何管理对象的依赖关系的？ <a class="header-anchor" href="#_3-spring中是如何管理对象的依赖关系的" aria-label="Permalink to &quot;3.Spring中是如何管理对象的依赖关系的？&quot;">​</a></h1><p>Spring中通过IoC来管理Bean对象。然后通过DI来管理Bean之间的依赖关系。</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/1fe7cd78ad0f442682ea3b6087e59f4f.png" alt="image.png" loading="lazy"></p><h2 id="_3-1-ioc的介绍" tabindex="-1">3.1 IoC的介绍 <a class="header-anchor" href="#_3-1-ioc的介绍" aria-label="Permalink to &quot;3.1 IoC的介绍&quot;">​</a></h2><p><strong>Spring中的</strong> （Inversion of Control）是一种设计原则，通过该原则，对象的创建和依赖关系的管理被转移到了容器中，从而降低了对象之间的耦合性。</p><p>从比较粗的角度介绍写IoC中的核心对象的作用：</p><ul><li><code>BeanDefinition</code>:BeanDefinition是Spring中定义Bean的元数据信息的接口。它包含了Bean的类名、属性、构造函数参数等信息，通过BeanDefinition可以告诉容器如何创建和配置Bean。</li><li><code>BeanDefinitionRegistry</code>：BeanDefinitionRegistry提供了对BeanDefinition的管理和操作功能，是Spring IoC容器中用于注册和管理Bean的核心接口。</li><li><code>BeanFactory</code>：BeanFactory是Spring IoC容器的核心接口，负责实例化、配置和管理应用中的对象（Bean）。它是IoC容器的基础，提供了一种获取Bean的机制，可以通过Bean的名称或类型来获取Bean的实例。</li><li><code>ApplicationContext</code>：ApplicationContext是BeanFactory的子接口，它是Spring中更高级的IoC容器。除了提供BeanFactory的功能外，它还提供了更多的企业级功能，例如国际化支持、事件发布、资源加载等。</li><li><code>BeanPostProcessor</code>：BeanPostProcessor是Spring中的一个扩展接口，用于在Bean实例化和依赖注入的过程中对Bean进行增强处理。通过实现BeanPostProcessor接口，可以在Bean的初始化前后对Bean进行自定义操作。</li><li><code>BeanWrapper</code>：BeanWrapper是Spring中对Bean对象的一种封装，提供了对Bean属性的访问和设置的方法。BeanWrapper可以对Bean的属性进行类型转换和验证等操作。</li></ul><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/6ab319e8a4634ca99739ec3e1a99f990.png" alt="image.png" loading="lazy"></p><p>更细节的初始化的过程：<a href="https://www.processon.com/view/link/64b8ac2c10ce753b813fc371" target="_blank" rel="noreferrer">https://www.processon.com/view/link/64b8ac2c10ce753b813fc371</a></p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/259c310f02cf493ab135af405d3178aa.png" alt="image.png" loading="lazy"></p><h2 id="_3-2-di的介绍" tabindex="-1">3.2 DI的介绍 <a class="header-anchor" href="#_3-2-di的介绍" aria-label="Permalink to &quot;3.2 DI的介绍&quot;">​</a></h2><p>通过上面的IoC的原理分析我们也可以看到DI的实现过程。其实就是在Bean的实例化过程中会处理对象的依赖关系。</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/6c69b7e4dc6a4468a44d51037bc5011b.png" alt="image.png" loading="lazy"></p><h1 id="_4-怎么解决依赖关系中的循环问题" tabindex="-1">4.怎么解决依赖关系中的循环问题？ <a class="header-anchor" href="#_4-怎么解决依赖关系中的循环问题" aria-label="Permalink to &quot;4.怎么解决依赖关系中的循环问题？&quot;">​</a></h1><h2 id="_4-1-普通的循环依赖问题" tabindex="-1">4.1 普通的循环依赖问题 <a class="header-anchor" href="#_4-1-普通的循环依赖问题" aria-label="Permalink to &quot;4.1 普通的循环依赖问题&quot;">​</a></h2><p>循环依赖问题不只是在Spring中有。平常的代码环境中也会存在。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CircularTest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CircularTest1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CircularTest1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CircularTest2 circularTest2 ;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CircularTest1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	   this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.circularTest2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CircularTest2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CircularTest2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CircularTest1 circularTest1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CircularTest1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CircularTest2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(CircularTest1 </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">circularTest1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 		this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.circularTest1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CircularTest1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>解决方案就是：</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/e689424a24a9436bbdbb51bd2565d144.png" alt="image.png" loading="lazy"></p><p>解决的本质为：</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/3444e774c1474b5fbd0033a98064985d.png" alt="image.png" loading="lazy"></p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/5b248726df9a41338b190459120e63af.png" alt="image.png" loading="lazy"></p><h2 id="_4-2-spring中的循环依赖" tabindex="-1">4.2 Spring中的循环依赖 <a class="header-anchor" href="#_4-2-spring中的循环依赖" aria-label="Permalink to &quot;4.2 Spring中的循环依赖&quot;">​</a></h2><p>Spring的核心是IoC和DI也就是对Bean的管理。这里肯定会涉及到对象之间关联关系的维护。那么就有可能会产生循环依赖的问题。在Spring中针对循环依赖的支持是：</p><ul><li>单例模式：构造注入不被支持</li><li>原型模式：都不支持---为什么设置注入的方式。循环依赖也不支持？ -- User对象。10W个对象</li></ul><p>Spring中解决循环依赖问题的关键是：</p><ul><li>提前暴露</li><li>三级缓存</li></ul><p>Spring中为了提供更加灵活的扩展和提高耦合性。在Bean对象的生命周期中提供了各种的后置处理器以及代理模式的应用。所以在处理循环依赖问题的时候也会比上面单纯的循环依赖问题的解决要更加的复杂些。这里需要弄清楚三级缓存中的每一级缓存的作用</p><ul><li>三级缓存：singletonFactories 存放的是一个Lambda表达式</li><li>二级缓存：存放的是不完整的Bean</li><li>一级缓存：最终完成实例化的Bean--- Spring中的Bean对象 单例对象 都保存在一级缓存中</li></ul><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/4736a7a309b449df82bccc6c6db3b000.png" alt="image.png" loading="lazy"></p><h1 id="_5-spring中aop介绍下" tabindex="-1">5.Spring中AOP介绍下 <a class="header-anchor" href="#_5-spring中aop介绍下" aria-label="Permalink to &quot;5.Spring中AOP介绍下&quot;">​</a></h1><h3 id="_5-1-aop的概念" tabindex="-1">5.1 AOP的概念 <a class="header-anchor" href="#_5-1-aop的概念" aria-label="Permalink to &quot;5.1 AOP的概念&quot;">​</a></h3><p><code>AOP</code>（面向切面编程）是一种软件设计思想，旨在通过将横切关注点与主要业务逻辑分离，提高代码的可维护性和可重用性。是 <code>OOP</code>(面向对象)的有效补充。</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/9ac78b5fb4e74c90b16ce71473ce175e.png" alt="image.png" loading="lazy"></p><p>在传统的面向对象编程中，代码的功能通常被分散在多个类中，这种分散导致了代码的重复和散乱。AOP的目标是通过将这些横切关注点（如日志记录、权限验证、事务管理等）从核心业务逻辑中分离出来，并将其封装成可复用的模块，从而实现代码的解耦和重用。</p><p>AOP的关键概念是切面（Aspect），切面是横切关注点的模块化，它定义了在何处（连接点）以及何时（切点）应用特定的横切关注点。切面可以通过通知（Advice）来实现具体的横切功能，通常包括前置通知（Before）、后置通知（After）、异常通知（AfterThrowing）和返回通知（AfterReturning）等。</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/c0ba20a3edd84eb88b5da8e213fb6025.png" alt="image.png" loading="lazy"></p><h3 id="_5-2-aop的实现方式" tabindex="-1">5.2 AOP的实现方式 <a class="header-anchor" href="#_5-2-aop的实现方式" aria-label="Permalink to &quot;5.2 AOP的实现方式&quot;">​</a></h3><p><a href="https://blog.csdn.net/qq_38526573/article/details/86441916" target="_blank" rel="noreferrer">https://blog.csdn.net/qq_38526573/article/details/86441916</a></p><h3 id="_5-3-aop源码分析" tabindex="-1">5.3 AOP源码分析 <a class="header-anchor" href="#_5-3-aop源码分析" aria-label="Permalink to &quot;5.3 AOP源码分析&quot;">​</a></h3><p><a href="https://dpb-bobokaoya-sm.blog.csdn.net/article/details/127263992" target="_blank" rel="noreferrer">https://dpb-bobokaoya-sm.blog.csdn.net/article/details/127263992</a></p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/161f6a280b6748c3a4bb4189b08209c5.png" alt="image.png" loading="lazy"></p><h2 id="_5-4-aop的实际应用" tabindex="-1">5.4 AOP的实际应用 <a class="header-anchor" href="#_5-4-aop的实际应用" aria-label="Permalink to &quot;5.4 AOP的实际应用&quot;">​</a></h2><ol><li>日志记录：通过AOP可以在方法执行前后记录日志，包括方法名、参数、返回值等信息，方便系统运维和故障排查。</li><li>安全验证：通过AOP可以在方法执行前进行安全验证，例如用户身份验证、权限控制等。</li><li>事务管理：通过AOP可以在方法执行前后开启、提交或回滚事务，确保数据一致性。</li><li>缓存管理：通过AOP可以在方法执行前检查缓存中是否存在结果，并在方法执行后将结果缓存起来，提高系统性能。</li><li>性能监控：通过AOP可以在方法执行前后统计方法的执行时间，并记录到日志中，方便性能优化和系统调优。</li><li>异常处理：通过AOP可以在方法执行过程中捕获异常，并进行统一的异常处理，例如返回特定的错误码或错误页面。</li><li>校验和验证：通过AOP可以在方法执行前对参数进行校验和验证，确保参数的合法性。</li><li>重试机制：通过AOP可以在方法执行失败时进行重试，以提高系统的容错能力。</li></ol><p>总之，Spring的AOP在实际工作中可以应用于各种场景，通过将通用的横切关注点集中处理，提高了系统的可维护性、可扩展性和代码的复用性。</p><h1 id="_6-spring中的事务介绍" tabindex="-1">6.Spring中的事务介绍 <a class="header-anchor" href="#_6-spring中的事务介绍" aria-label="Permalink to &quot;6.Spring中的事务介绍&quot;">​</a></h1><h2 id="_6-1-事务的介绍" tabindex="-1">6.1 事务的介绍 <a class="header-anchor" href="#_6-1-事务的介绍" aria-label="Permalink to &quot;6.1 事务的介绍&quot;">​</a></h2><p><strong>数据库事务</strong>(Database Transaction) ，是指作为单个逻辑工作单元执行的一系列操作，要么完全地执行，要么完全地不执行。</p><p>事务处理可以确保除非事务性单元内的所有操作都成功完成，否则不会永久更新面向数据的资源。通过将一组相关操作组合为一个要么全部成功要么全部失败的单元，可以简化错误恢复并使应用程序更加可靠。</p><p>一个逻辑工作单元要成为事务，必须满足所谓的 <code>ACID</code>（原子性、一致性、隔离性和持久性）属性。事务是数据库运行中的逻辑工作单位，由DBMS中的事务管理子系统负责事务的处理。</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/523987641a9a4a86930bc8eb5e7c5a85.png" alt="image.png" loading="lazy"></p><h2 id="_6-2-spring中事务的实现" tabindex="-1">6.2 Spring中事务的实现 <a class="header-anchor" href="#_6-2-spring中事务的实现" aria-label="Permalink to &quot;6.2 Spring中事务的实现&quot;">​</a></h2><p>Spring中的事务实现有两种方式：</p><ul><li>基于配置文件</li><li>基于注解：@Transactionl</li></ul><h2 id="_6-3-spring中事务的原理" tabindex="-1">6.3 Spring中事务的原理 <a class="header-anchor" href="#_6-3-spring中事务的原理" aria-label="Permalink to &quot;6.3 Spring中事务的原理&quot;">​</a></h2><h3 id="_6-3-1-事务的设计" tabindex="-1">6.3.1 事务的设计 <a class="header-anchor" href="#_6-3-1-事务的设计" aria-label="Permalink to &quot;6.3.1 事务的设计&quot;">​</a></h3><p><strong>事务管理器</strong>：</p><p>事务管理器(PlatformTransactionManager).</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/bffecea5356b42b1a02f7965f52741cf.png" alt="image.png" loading="lazy"></p><p><strong>事务的定义：<code>TransactionDefinition</code></strong></p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/296772289b6a4ea7ae1c3fddf2097bf5.png" alt="image.png" loading="lazy"></p><p><strong>事务的开启 <code>TransactionStatus</code></strong></p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/5593e08e4458429290dbb11d79ed8f63.png" alt="image.png" loading="lazy"></p><p>核心方法演示：</p><p><code>getTransaction()</code>方法</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>	/**</span></span>
<span class="line"><span>	 * This implementation handles propagation behavior. Delegates to</span></span>
<span class="line"><span>	 * {@code doGetTransaction}, {@code isExistingTransaction}</span></span>
<span class="line"><span>	 * and {@code doBegin}.</span></span>
<span class="line"><span>	 * @see #doGetTransaction</span></span>
<span class="line"><span>	 * @see #isExistingTransaction</span></span>
<span class="line"><span>	 * @see #doBegin</span></span>
<span class="line"><span>	 */</span></span>
<span class="line"><span>	@Override</span></span>
<span class="line"><span>	public final TransactionStatus getTransaction(@Nullable TransactionDefinition definition)</span></span>
<span class="line"><span>			throws TransactionException {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>		// Use defaults if no transaction definition given.</span></span>
<span class="line"><span>		// 如果没有事务定义信息则使用默认的事务管理器定义信息</span></span>
<span class="line"><span>		TransactionDefinition def = (definition != null ? definition : TransactionDefinition.withDefaults());</span></span>
<span class="line"><span></span></span>
<span class="line"><span>		// 获取事务</span></span>
<span class="line"><span>		Object transaction = doGetTransaction();</span></span>
<span class="line"><span>		boolean debugEnabled = logger.isDebugEnabled();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>		// 判断当前线程是否存在事务，判断依据为当前线程记录的连接不为空且连接中的transactionActive属性不为空</span></span>
<span class="line"><span>		if (isExistingTransaction(transaction)) {</span></span>
<span class="line"><span>			// Existing transaction found -&gt; check propagation behavior to find out how to behave.</span></span>
<span class="line"><span>			// 当前线程已经存在事务</span></span>
<span class="line"><span>			return handleExistingTransaction(def, transaction, debugEnabled);</span></span>
<span class="line"><span>		}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>		// Check definition settings for new transaction.</span></span>
<span class="line"><span>		// 事务超时设置验证</span></span>
<span class="line"><span>		if (def.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) {</span></span>
<span class="line"><span>			throw new InvalidTimeoutException(&quot;Invalid transaction timeout&quot;, def.getTimeout());</span></span>
<span class="line"><span>		}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>		// No existing transaction found -&gt; check propagation behavior to find out how to proceed.</span></span>
<span class="line"><span>		// 如果当前线程不存在事务，但是PropagationBehavior却被声明为PROPAGATION_MANDATORY抛出异常</span></span>
<span class="line"><span>		if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) {</span></span>
<span class="line"><span>			throw new IllegalTransactionStateException(</span></span>
<span class="line"><span>					&quot;No existing transaction found for transaction marked with propagation &#39;mandatory&#39;&quot;);</span></span>
<span class="line"><span>		}</span></span>
<span class="line"><span>		// PROPAGATION_REQUIRED，PROPAGATION_REQUIRES_NEW，PROPAGATION_NESTED都需要新建事务</span></span>
<span class="line"><span>		else if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||</span></span>
<span class="line"><span>				def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||</span></span>
<span class="line"><span>				def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) {</span></span>
<span class="line"><span>			//没有当前事务的话，REQUIRED，REQUIRES_NEW，NESTED挂起的是空事务，然后创建一个新事务</span></span>
<span class="line"><span>			SuspendedResourcesHolder suspendedResources = suspend(null);</span></span>
<span class="line"><span>			if (debugEnabled) {</span></span>
<span class="line"><span>				logger.debug(&quot;Creating new transaction with name [&quot; + def.getName() + &quot;]: &quot; + def);</span></span>
<span class="line"><span>			}</span></span>
<span class="line"><span>			try {</span></span>
<span class="line"><span>				return startTransaction(def, transaction, debugEnabled, suspendedResources);</span></span>
<span class="line"><span>			}</span></span>
<span class="line"><span>			catch (RuntimeException | Error ex) {</span></span>
<span class="line"><span>				// 恢复挂起的事务</span></span>
<span class="line"><span>				resume(null, suspendedResources);</span></span>
<span class="line"><span>				throw ex;</span></span>
<span class="line"><span>			}</span></span>
<span class="line"><span>		}</span></span>
<span class="line"><span>		else {</span></span>
<span class="line"><span>			// Create &quot;empty&quot; transaction: no actual transaction, but potentially synchronization.</span></span>
<span class="line"><span>			// 创建一个空的事务</span></span>
<span class="line"><span>			if (def.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT &amp;&amp; logger.isWarnEnabled()) {</span></span>
<span class="line"><span>				logger.warn(&quot;Custom isolation level specified but no actual transaction initiated; &quot; +</span></span>
<span class="line"><span>						&quot;isolation level will effectively be ignored: &quot; + def);</span></span>
<span class="line"><span>			}</span></span>
<span class="line"><span>			boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</span></span>
<span class="line"><span>			return prepareTransactionStatus(def, null, true, newSynchronization, debugEnabled, null);</span></span>
<span class="line"><span>		}</span></span>
<span class="line"><span>	}</span></span></code></pre></div><p>关键的方法：doGetTransaction()方法</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 * 创建一个DataSourceTransactionObject当作事务，设置是否允许保存点，然后获取连接持有器ConnectionHolder</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 * 里面会存放JDBC的连接，设置给DataSourceTransactionObject,当然第一次是空的</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@return</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doGetTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 创建一个数据源事务对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		DataSourceTransactionObject txObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DataSourceTransactionObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 是否允许当前事务设置保持点</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setSavepointAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isNestedTransactionAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		 * TransactionSynchronizationManager 事务同步管理器对象(该类中都是局部线程变量)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		 * 用来保存当前事务的信息,我们第一次从这里去线程变量中获取 事务连接持有器对象 通过数据源为key去获取</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		 * 由于第一次进来开始事务 我们的事务同步管理器中没有被存放.所以此时获取出来的conHolder为null</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		ConnectionHolder conHolder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				(ConnectionHolder) TransactionSynchronizationManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getResource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">obtainDataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 非新创建连接则写false</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setConnectionHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(conHolder, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 返回事务对象</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> txObject;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>然后事务管理的代码</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 * Create a TransactionStatus for an existing transaction.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TransactionStatus </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handleExistingTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			TransactionDefinition definition, Object transaction, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> debugEnabled)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			throws TransactionException {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		 * 判断当前的事务行为是不是PROPAGATION_NEVER的</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		 * 表示为不支持事务,但是当前又存在一个事务,所以抛出异常</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (definition.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getPropagationBehavior</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TransactionDefinition.PROPAGATION_NEVER) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IllegalTransactionStateException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">					&quot;Existing transaction found for transaction marked with propagation &#39;never&#39;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		 * 判断当前的事务属性不支持事务,PROPAGATION_NOT_SUPPORTED,所以需要先挂起已经存在的事务</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (definition.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getPropagationBehavior</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TransactionDefinition.PROPAGATION_NOT_SUPPORTED) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (debugEnabled) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Suspending current transaction&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 挂起当前事务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			Object suspendedResources </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> suspend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(transaction);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> newSynchronization </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTransactionSynchronization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SYNCHRONIZATION_ALWAYS);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 创建一个新的非事务状态(保存了上一个存在事务状态的属性)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> prepareTransactionStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					definition, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, newSynchronization, debugEnabled, suspendedResources);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		 * 当前的事务属性状态是PROPAGATION_REQUIRES_NEW表示需要新开启一个事务状态</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (definition.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getPropagationBehavior</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TransactionDefinition.PROPAGATION_REQUIRES_NEW) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (debugEnabled) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Suspending current transaction, creating new transaction with name [&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">						definition.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;]&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 挂起当前事务并返回挂起的资源持有器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			SuspendedResourcesHolder suspendedResources </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> suspend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(transaction);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// 创建一个新的非事务状态(保存了上一个存在事务状态的属性)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> startTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(definition, transaction, debugEnabled, suspendedResources);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (RuntimeException | Error </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">beginEx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">				resumeAfterBeginException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(transaction, suspendedResources, beginEx);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> beginEx;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 嵌套事务</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (definition.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getPropagationBehavior</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TransactionDefinition.PROPAGATION_NESTED) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 不允许就报异常</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isNestedTransactionAllowed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> NestedTransactionNotSupportedException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">						&quot;Transaction manager does not allow nested transactions by default - &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">						&quot;specify &#39;nestedTransactionAllowed&#39; property with value &#39;true&#39;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (debugEnabled) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Creating nested transaction with name [&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> definition.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;]&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 嵌套事务的处理</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">useSavepointForNestedTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// Create savepoint within existing Spring-managed transaction,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// through the SavepointManager API implemented by TransactionStatus.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// 如果没有可以使用保存点的方式控制事务回滚，那么在嵌入式事务的建立初始简历保存点</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				DefaultTransactionStatus status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">						prepareTransactionStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(definition, transaction, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, debugEnabled, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// 为事务设置一个回退点</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				status.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createAndHoldSavepoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> status;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// Nested transaction through nested begin and commit/rollback calls.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// Usually only for JTA: Spring synchronization might get activated here</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// in case of a pre-existing JTA transaction.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// 有些情况是不能使用保存点操作</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> startTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(definition, transaction, debugEnabled, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// Assumably PROPAGATION_SUPPORTS or PROPAGATION_REQUIRED.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (debugEnabled) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Participating in existing transaction&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isValidateExistingTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (definition.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getIsolationLevel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TransactionDefinition.ISOLATION_DEFAULT) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				Integer currentIsolationLevel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TransactionSynchronizationManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCurrentTransactionIsolationLevel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (currentIsolationLevel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentIsolationLevel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> definition.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getIsolationLevel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					Constants isoConstants </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DefaultTransactionDefinition.constants;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">					throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IllegalTransactionStateException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Participating transaction with definition [&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">							definition </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;] specifies isolation level which is incompatible with existing transaction: &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">							(currentIsolationLevel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">									isoConstants.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">toCode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(currentIsolationLevel, DefaultTransactionDefinition.PREFIX_ISOLATION) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">									&quot;(unknown)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">definition.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isReadOnly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (TransactionSynchronizationManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isCurrentTransactionReadOnly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">					throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IllegalTransactionStateException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Participating transaction with definition [&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">							definition </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;] is not marked as read-only but existing transaction is&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> newSynchronization </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTransactionSynchronization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SYNCHRONIZATION_NEVER);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> prepareTransactionStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(definition, transaction, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, newSynchronization, debugEnabled, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>最后来看看 startTransaction() 方法</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 * Start a new transaction.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TransactionStatus </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">startTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TransactionDefinition definition, Object transaction,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> debugEnabled, @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Nullable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SuspendedResourcesHolder suspendedResources) {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 是否需要新同步</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> newSynchronization </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTransactionSynchronization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SYNCHRONIZATION_NEVER);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 创建新的事务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		DefaultTransactionStatus status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> newTransactionStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				definition, transaction, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, newSynchronization, debugEnabled, suspendedResources);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 开启事务和连接</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		doBegin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(transaction, definition);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 新同步事务的设置，针对于当前线程的设置</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		prepareSynchronization</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(status, definition);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> status;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>doBegin方法开启和连接事务</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	protected</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> doBegin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Object transaction, TransactionDefinition definition) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 强制转化事务对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		DataSourceTransactionObject txObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (DataSourceTransactionObject) transaction;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		Connection con </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 判断事务对象没有数据库连接持有器</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hasConnectionHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getConnectionHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isSynchronizedWithTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// 通过数据源获取一个数据库连接对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				Connection newCon </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> obtainDataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getConnection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isDebugEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Acquired Connection [&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> newCon </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;] for JDBC transaction&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// 把我们的数据库连接包装成一个ConnectionHolder对象 然后设置到我们的txObject对象中去</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setConnectionHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ConnectionHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(newCon), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 标记当前的连接是一个同步事务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getConnectionHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setSynchronizedWithTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			con </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getConnectionHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getConnection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 为当前的事务设置隔离级别</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			Integer previousIsolationLevel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DataSourceUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prepareConnectionForTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(con, definition);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 设置先前隔离级别</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setPreviousIsolationLevel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(previousIsolationLevel);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 设置是否只读</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setReadOnly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(definition.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isReadOnly</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// Switch to manual commit if necessary. This is very expensive in some JDBC drivers,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// so we don&#39;t want to do it unnecessarily (for example if we&#39;ve explicitly</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// configured the connection pool to set it already).</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 关闭自动提交</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (con.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getAutoCommit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				//设置需要恢复自动提交</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setMustRestoreAutoCommit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isDebugEnabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">debug</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Switching JDBC Connection [&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> con </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;] to manual commit&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// 关闭自动提交</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				con.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setAutoCommit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 判断事务是否需要设置为只读事务</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">			prepareTransactionalConnection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(con, definition);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 标记激活事务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getConnectionHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setTransactionActive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 设置事务超时时间</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> timeout </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> determineTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(definition);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (timeout </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TransactionDefinition.TIMEOUT_DEFAULT) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getConnectionHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setTimeoutInSeconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(timeout);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// Bind the connection holder to the thread.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 绑定我们的数据源和连接到我们的同步管理器上，把数据源作为key,数据库连接作为value 设置到线程变量中</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isNewConnectionHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// 将当前获取到的连接绑定到当前线程</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				TransactionSynchronizationManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bindResource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">obtainDataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getConnectionHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Throwable </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isNewConnectionHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// 释放数据库连接</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				DataSourceUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">releaseConnection</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(con, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">obtainDataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				txObject.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setConnectionHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CannotCreateTransactionException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Could not open JDBC Connection for transaction&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ex);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>在doBegin方法中核心的关闭了自动提交</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1665474496079/a33ceb498031496b81ae92c8a0c0c916.png" alt="image.png" loading="lazy"></p><p>同时把连接绑定到本地线程中bindResource方法</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/49225d9f065b4d989d6f53a11c81f33e.png" alt="image.png" loading="lazy"></p><h3 id="_6-3-2-aop串联" tabindex="-1">6.3.2 AOP串联 <a class="header-anchor" href="#_6-3-2-aop串联" aria-label="Permalink to &quot;6.3.2 AOP串联&quot;">​</a></h3><p>编程式事务：</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UserDao userDao;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PlatformTransactionManager txManager;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Autowired</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LogService logService;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Transactional</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> insertUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(User u) {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 1、创建事务定义</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		DefaultTransactionDefinition definition </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DefaultTransactionDefinition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 2、根据定义开启事务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		TransactionStatus status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> txManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(definition);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.userDao.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">insert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(u);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			Log log </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentTimeMillis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, System.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">currentTimeMillis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;-&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> u.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getUserName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// this.doAddUser(u);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">			this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">insertLog</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(log);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 3、提交事务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			txManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">commit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(status);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Exception </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">e</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 4、异常了，回滚事务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			txManager.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rollback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(status);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p><strong>AOP事务</strong></p><p>上面的案例代码我们可以看到在Service中我们通过事务处理的代码实现了事务管理，同时结合我们前面学习的AOP的内容，我们发现我们完全可以把事务的代码抽取出来，然后我们来看看Spring中这块是如何处理的。</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/da2303ed21e44317b68ace87c8e8a2da.png" alt="image.png" loading="lazy"></p><p>我们可以通过Debug的方式看到处理的关键流程 <code>TransactionInterceptor</code> 就是事务处理的 advice</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Nullable</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">invoke</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(MethodInvocation invocation) throws Throwable {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// Work out the target class: may be {@code null}.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// The TransactionAttributeSource should be passed the target class</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// as well as the method, which may be from an interface.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		Class&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; targetClass </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (invocation.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getThis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> AopUtils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTargetClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(invocation.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getThis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// Adapt to TransactionAspectSupport&#39;s invokeWithinTransaction...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> invokeWithinTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(invocation.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), targetClass, invocation</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">proceed);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>进入到invokeWithinTransaction方法中</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Nullable</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	protected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">invokeWithinTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Method method, @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Nullable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Class</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> targetClass,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> InvocationCallback invocation) throws Throwable {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// If the transaction attribute is null, the method is non-transactional.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 获取我们的事务属性源对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		TransactionAttributeSource tas </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getTransactionAttributeSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 通过事务属性源对象获取到当前方法的事务属性信息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TransactionAttribute txAttr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (tas </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tas.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTransactionAttribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(method, targetClass) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 获取我们配置的事务管理器对象</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> TransactionManager tm </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> determineTransactionManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(txAttr);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.reactiveAdapterRegistry </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tm </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ReactiveTransactionManager) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			ReactiveTransactionSupport txSupport </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.transactionSupportCache.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">computeIfAbsent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(method, key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (KotlinDetector.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isKotlinType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(method.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getDeclaringClass</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KotlinDelegate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isSuspend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(method)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">					throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TransactionUsageException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">							&quot;Unsupported annotated transaction on suspending function detected: &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> method </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">							&quot;. Use TransactionalOperator.transactional extensions instead.&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				ReactiveAdapter adapter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.reactiveAdapterRegistry.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getAdapter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(method.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getReturnType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (adapter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">					throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IllegalStateException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Cannot apply reactive transaction to non-reactive return type: &quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> +</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">							method.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getReturnType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ReactiveTransactionSupport</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(adapter);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			});</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> txSupport.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">invokeWithinTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					method, targetClass, invocation, txAttr, (ReactiveTransactionManager) tm);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		PlatformTransactionManager ptm </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> asPlatformTransactionManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tm);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 获取连接点的唯一标识  类名+方法名</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> String joinpointIdentification </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> methodIdentification</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(method, targetClass, txAttr);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 声明式事务处理</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (txAttr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptm </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CallbackPreferringPlatformTransactionManager)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// Standard transaction demarcation with getTransaction and commit/rollback calls.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 创建TransactionInfo</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			TransactionInfo txInfo </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createTransactionIfNecessary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptm, txAttr, joinpointIdentification);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			Object retVal;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// This is an around advice: Invoke the next interceptor in the chain.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// This will normally result in a target object being invoked.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// 执行被增强方法,调用具体的处理逻辑</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				retVal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> invocation.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">proceedWithInvocation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Throwable </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// target invocation exception</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// 异常回滚</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">				completeTransactionAfterThrowing</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(txInfo, ex);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ex;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				//清除事务信息，恢复线程私有的老的事务信息</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">				cleanupTransactionInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(txInfo);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (retVal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vavrPresent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> VavrDelegate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isVavrTry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(retVal)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// Set rollback-only in case of Vavr failure matching our rollback rules...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				TransactionStatus status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> txInfo.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTransactionStatus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> txAttr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					retVal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> VavrDelegate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">evaluateTryFailure</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(retVal, txAttr, status);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			//成功后提交，会进行资源储量，连接释放，恢复挂起事务等操作</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">			commitTransactionAfterReturning</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(txInfo);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> retVal;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// 编程式事务处理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			Object result;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ThrowableHolder throwableHolder </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ThrowableHolder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// It&#39;s a CallbackPreferringPlatformTransactionManager: pass a TransactionCallback in.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((CallbackPreferringPlatformTransactionManager) ptm).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">execute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(txAttr, status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					TransactionInfo txInfo </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> prepareTransactionInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptm, txAttr, joinpointIdentification, status);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">					try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">						Object retVal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> invocation.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">proceedWithInvocation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">						if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (retVal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vavrPresent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> VavrDelegate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isVavrTry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(retVal)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">							// Set rollback-only in case of Vavr failure matching our rollback rules...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">							retVal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> VavrDelegate.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">evaluateTryFailure</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(retVal, txAttr, status);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">						}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">						return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> retVal;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">					catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Throwable </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">						if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (txAttr.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rollbackOn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ex)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">							// A RuntimeException: will lead to a rollback.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">							if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ex </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RuntimeException) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">								throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (RuntimeException) ex;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">							}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">							else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">								throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ThrowableHolderException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ex);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">							}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">						}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">						else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">							// A normal return value: will lead to a commit.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">							throwableHolder.throwable </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ex;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">							return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">						}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">					finally</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">						cleanupTransactionInfo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(txInfo);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				});</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ThrowableHolderException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ex.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCause</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (TransactionSystemException </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ex2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (throwableHolder.throwable </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Application exception overridden by commit exception&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, throwableHolder.throwable);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					ex2.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">initApplicationException</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(throwableHolder.throwable);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ex2;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Throwable </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ex2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (throwableHolder.throwable </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					logger.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Application exception overridden by commit exception&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, throwableHolder.throwable);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ex2;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// Check result state: It might indicate a Throwable to rethrow.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (throwableHolder.throwable </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				throw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> throwableHolder.throwable;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span></code></pre></div><p>然后进入到createTransactionIfNecessary方法中</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/46dfc6fdeddb48479cafc0195a48eef8.png" alt="image.png" loading="lazy"></p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/aeb6499ef08b49428fbbb68d4da73da4.png" alt="image.png" loading="lazy"></p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/e64d10a179c644c8a479e4247d0a2a5a.png" alt="image.png" loading="lazy"></p><p>核心的是doBegin方法。完成 自动提交的关闭和 本地线程 对象的存储</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/d2b5509ff0334468b80bcd5685202a87.png" alt="image.png" loading="lazy"></p><p><strong>TransactionInterceptor</strong></p><p>接下来看看TransactionInterceptor是如何注入到容器中的，首先来看看事务的开启</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/8bd5840dd127478d9e6f5bd2b7e8ad92.png" alt="image.png" loading="lazy"></p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/54112de96f1c4c2f850482d82567e044.png" alt="image.png" loading="lazy"></p><p>一步步进入</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/ff42af84894a40aab7495663ee8b6bdb.png" alt="image.png" loading="lazy"></p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/74b7b53f7d5f4f528a6f35e52c49bf8d.png" alt="image.png" loading="lazy"></p><p>可以看到对应的拦截器的注入</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/49c074784b2b492d8383acae6e27b7a1.png" alt="image.png" loading="lazy"></p><p>然后可以看到拦截器关联到了Advisor中了</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/b371ef1a62c34b41be7ba638e4fccdc4.png" alt="image.png" loading="lazy"></p><h1 id="_7-spring中应用了哪些设计模式" tabindex="-1">7.Spring中应用了哪些设计模式？ <a class="header-anchor" href="#_7-spring中应用了哪些设计模式" aria-label="Permalink to &quot;7.Spring中应用了哪些设计模式？&quot;">​</a></h1><p>列举几种讲解：</p><ol><li>单例模式（Singleton Pattern）：Spring中的Bean默认是单例的，通过Spring容器管理的Bean都是单例的，保证了对象的唯一性。</li><li>工厂模式（Factory Pattern）：Spring中的Bean工厂（BeanFactory）和应用上下文（ApplicationContext）都是工厂模式的实现，通过工厂模式可以统一管理对象的创建。</li><li>代理模式（Proxy Pattern）：Spring中的AOP（面向切面编程）就是通过代理模式来实现的，通过动态代理可以实现对目标对象的增强。</li><li>观察者模式（Observer Pattern）：Spring中的事件驱动机制就是基于观察者模式实现的，通过ApplicationEvent和ApplicationListener来实现事件的发布和监听。</li><li>适配器模式（Adapter Pattern）：Spring中的适配器模式主要体现在MVC框架中，通过HandlerAdapter来适配不同类型的处理器。</li><li>模板方法模式（Template Method Pattern）：Spring中的JdbcTemplate就是模板方法模式的应用，通过定义好的模板方法来实现数据库操作的基本流程，具体的实现由子类来完成。</li><li>策略模式（Strategy Pattern）：Spring中的事务管理机制就是基于策略模式实现的，通过不同的事务策略来实现不同的事务管理方式。</li></ol><h1 id="_8-谈谈你对springmvc的理解" tabindex="-1">8. 谈谈你对SpringMVC的理解 <a class="header-anchor" href="#_8-谈谈你对springmvc的理解" aria-label="Permalink to &quot;8. 谈谈你对SpringMVC的理解&quot;">​</a></h1><p>这是个相对比较简单的问题。我们可以从这几个角度来回答</p><h2 id="_8-1-什么是mvc" tabindex="-1">8.1 什么是MVC <a class="header-anchor" href="#_8-1-什么是mvc" aria-label="Permalink to &quot;8.1 什么是MVC&quot;">​</a></h2><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/5622e50acdbd443c8364ac10e3150165.png" alt="image.png" loading="lazy"></p><h2 id="_8-2-springmvc原理" tabindex="-1">8.2 SpringMVC原理 <a class="header-anchor" href="#_8-2-springmvc原理" aria-label="Permalink to &quot;8.2 SpringMVC原理&quot;">​</a></h2><p>SpringMVC是基于Java的开源框架，用于构建Web应用程序。它是Spring框架的一部分，采用了MVC（模型-视图-控制器）架构模式。</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/ef7c41f371a443a1b39b67ff7e17e00e.png" alt="image.png" loading="lazy"></p><p>核心对象：</p><ol><li>DispatcherServlet：DispatcherServlet是SpringMVC的核心组件，负责接收HTTP请求并将请求分发给相应的控制器处理。它充当了前端控制器的角色，负责协调请求处理过程中的各个组件。</li><li>HandlerMapping：HandlerMapping负责将HTTP请求映射到相应的处理器（Controller）上。它根据请求的URL和其他条件来确定具体的处理器。</li><li>HandlerAdapter：HandlerAdapter负责将请求分发给相应的处理器进行处理，并将处理结果封装成ModelAndView对象返回给DispatcherServlet。不同类型的处理器可能需要不同的HandlerAdapter进行适配。</li><li>HandlerInterceptor：HandlerInterceptor是一个拦截器接口，可以在请求处理的前后执行一些额外的处理逻辑。它可以用来实现权限验证、日志记录等功能。</li><li>ViewResolver：ViewResolver负责根据视图名称解析出具体的视图对象。它可以根据不同的视图解析策略来确定最终的视图对象。</li><li>View：View负责将模型数据渲染成最终的响应内容。它可以是JSP、HTML、JSON等不同类型的视图。</li><li>Model：Model用于封装处理结果数据，供视图层进行渲染。它可以是一个简单的POJO对象，也可以是一个Map或者ModelAndView对象。</li></ol><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/c0ebd8bca6464fcd90f7c8be9b14350e.png" alt="image.png" loading="lazy"></p><h1 id="_9-如果对响应数据做通用处理" tabindex="-1">9.如果对响应数据做通用处理? <a class="header-anchor" href="#_9-如果对响应数据做通用处理" aria-label="Permalink to &quot;9.如果对响应数据做通用处理?&quot;">​</a></h1><p>这个问题针对的是SpringMVC控制器处理完业务请求后给前端服务做相关的响应。这块我们可以对 <code>HandlerMethodReturnValueHandler</code>做相关的真强。</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> * 对Controller响应请求的数据做装饰增强</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Configuration</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InitializingAdviceDecorator</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InitializingBean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RequestMappingHandlerAdapter adapter;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> InitializingAdviceDecorator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(RequestMappingHandlerAdapter </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">adapter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.adapter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> adapter;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> afterPropertiesSet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //获取所有的handler对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HandlerMethodReturnValueHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; returnValueHandlers </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> adapter.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getReturnValueHandlers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //因为上面返回的是unmodifiableList，所以需要新建list处理</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        assert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> returnValueHandlers </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HandlerMethodReturnValueHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; handlers </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ArrayList&lt;&gt;(returnValueHandlers);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">decorateHandlers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handlers); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 对 对应的 handler 做装饰增强</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //将增强的返回值回写回去</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        adapter.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setReturnValueHandlers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handlers);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * 使用自定义的返回值控制类</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> handlers</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> decorateHandlers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">HandlerMethodReturnValueHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">handlers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (HandlerMethodReturnValueHandler handler </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handlers) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (handler </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> RequestResponseBodyMethodProcessor) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                //找到返回值的handler并将起包装成自定义的handler</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                ControllerReturnValueHandler decorator </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ControllerReturnValueHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((RequestResponseBodyMethodProcessor) handler);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> index </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handlers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">indexOf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(handler);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                handlers.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(index, decorator);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * 自定义返回值的Handler</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     * 采用装饰者模式</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ControllerReturnValueHandler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HandlerMethodReturnValueHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //持有一个被装饰者对象</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        private</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> final</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> HandlerMethodReturnValueHandler handler;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        ControllerReturnValueHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(RequestResponseBodyMethodProcessor </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">handler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.handler </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> handler;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> boolean</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> supportsReturnType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(MethodParameter </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">returnType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         * 增强被装饰者的功能</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         *</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> returnValue</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  返回值</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> returnType</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   返回类型</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> mavContainer</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> view</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@param</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> webRequest</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   请求对象</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         * </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">@throws</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Exception</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 抛出异常</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Override</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Object </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">returnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, MethodParameter </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">returnType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ModelAndViewContainer </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mavContainer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, NativeWebRequest </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">webRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Exception {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            //如果是下载文件跳过包装</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            IgnoredResultWrapper ignoredResultWrapper </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> returnType.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMethodAnnotation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(IgnoredResultWrapper.class);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ignoredResultWrapper </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                handler.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handleReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(returnValue, returnType, mavContainer, webRequest);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (returnValue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                Optional&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; contentType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Optional.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">of</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(webRequest)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(nativeWebRequest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((ServletWebRequest) webRequest))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ServletRequestAttributes</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">getResponse)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                        .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ServletResponse</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">getContentType);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (contentType.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">isPresent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> contentType.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">contains</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;application/vnd.openxmlformats-officedocument&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            //如果已经封装了结构体就直接放行</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (returnValue </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">instanceof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ResultWrapper) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                handler.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handleReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(returnValue, returnType, mavContainer, webRequest);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            //正常返回success</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            ResultWrapper&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; success </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ResultWrapper.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">success</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(returnValue);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            handler.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handleReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(success, returnType, mavContainer, webRequest);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h1 id="_10-谈谈对springboot的理解" tabindex="-1">10.谈谈对SpringBoot的理解 <a class="header-anchor" href="#_10-谈谈对springboot的理解" aria-label="Permalink to &quot;10.谈谈对SpringBoot的理解&quot;">​</a></h1><h2 id="_10-1-回答的关键" tabindex="-1">10.1 回答的关键 <a class="header-anchor" href="#_10-1-回答的关键" aria-label="Permalink to &quot;10.1 回答的关键&quot;">​</a></h2><ul><li>约定优于配置</li><li>自动扫描</li><li>本质就是Spring的脚手架</li><li>@EnableAutoConfiguration</li><li>spring.factories</li><li>条件注解</li></ul><h2 id="_10-2-源码的梳理" tabindex="-1">10.2 源码的梳理 <a class="header-anchor" href="#_10-2-源码的梳理" aria-label="Permalink to &quot;10.2 源码的梳理&quot;">​</a></h2><p>源码梳理从四个方面介绍</p><ul><li>run方法：Spring容器的初始化</li><li>@SpringBootApplication注解:自动扫描、自动装配</li><li>两者之间是怎么串联的: @Configuration BFPP --&gt; import bean</li><li>自定义starter</li></ul><p><code>https://www.processon.com/view/link/64c06b8938c1420369f6958a</code></p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/c2419456d3474e02a4b60dc05c523f1d.png" alt="image.png" loading="lazy"></p><h1 id="_11-谈谈你对springsecurity的理解" tabindex="-1">11.谈谈你对SpringSecurity的理解 <a class="header-anchor" href="#_11-谈谈你对springsecurity的理解" aria-label="Permalink to &quot;11.谈谈你对SpringSecurity的理解&quot;">​</a></h1><h2 id="_11-1-springsecurity的介绍" tabindex="-1">11.1 SpringSecurity的介绍 <a class="header-anchor" href="#_11-1-springsecurity的介绍" aria-label="Permalink to &quot;11.1 SpringSecurity的介绍&quot;">​</a></h2><p>Spring Security是一个基于Spring框架的开源安全框架，它提供了一套全面的安全解决方案，用于保护Java应用程序的安全性。</p><p>Spring Security的主要功能包括 <code>身份验证</code>、<code>授权</code>、<code>密码加密</code>、<code>会话管理</code>和 <code>安全事件处理</code>等。它可以集成到各种类型的应用程序中，包括Web应用程序、RESTful服务和微服务等。</p><h2 id="_11-2-springsecurity的实现原理" tabindex="-1">11.2 SpringSecurity的实现原理 <a class="header-anchor" href="#_11-2-springsecurity的实现原理" aria-label="Permalink to &quot;11.2 SpringSecurity的实现原理&quot;">​</a></h2><p><a href="https://www.processon.com/view/link/5f708e967d9c08039fbe2110" target="_blank" rel="noreferrer">https://www.processon.com/view/link/5f708e967d9c08039fbe2110</a></p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/c3d9f6b8097e45fcab39d3ec6424b00a.png" alt="image.png" loading="lazy"></p><h1 id="_12-介绍下jwt和token的关系" tabindex="-1">12.介绍下JWT和Token的关系 <a class="header-anchor" href="#_12-介绍下jwt和token的关系" aria-label="Permalink to &quot;12.介绍下JWT和Token的关系&quot;">​</a></h1><p><a href="https://jwt.io/" target="_blank" rel="noreferrer">https://jwt.io/</a></p><p>JWT（JSON Web Token）是一种用于身份验证和授权的开放标准（RFC 7519）。它是一种轻量级的安全凭证，以JSON格式存储信息，并使用数字签名或加密进行验证。</p><p>Token是一种在身份验证和授权中用于识别用户的凭证。它可以是任何形式的字符串，通常由服务器生成并返回给客户端。Token可以用来验证用户身份、授权用户访问特定资源或服务，并在一定时间内保持有效。</p><p>JWT是一种特定类型的Token，它使用JSON格式存储信息，并使用数字签名或加密来验证其完整性和真实性。JWT由三部分组成：头部（Header）、负载（Payload）和签名（Signature）。头部和负载以Base64编码的形式存储，并用点号连接起来，形成JWT的第一部分。签名是通过对头部、负载和密钥进行加密生成的，用于验证JWT的真实性。</p><p>Token可以是任何形式的字符串，包括JWT。JWT是一种更安全和可扩展的Token，它可以包含更多的信息，并且通过数字签名或加密来验证其真实性。与传统的Token相比，JWT具有更好的灵活性和安全性，并且可以在不同的应用程序中共享和验证。</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/24f6059f38684390ad1a8068f42b4f19.png" alt="image.png" loading="lazy"></p><h1 id="_13-谈谈shiro的实现原理" tabindex="-1">13.谈谈Shiro的实现原理 <a class="header-anchor" href="#_13-谈谈shiro的实现原理" aria-label="Permalink to &quot;13.谈谈Shiro的实现原理&quot;">​</a></h1><p>Shiro的认证和授权的实现本质上是通过各种过滤器来实现的。具体如下图：</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/8b68ccd66a5c4aaa83a6313c653dae65.png" alt="image.png" loading="lazy"></p><h1 id="_14-谈谈你对mybatis的理解" tabindex="-1">14.谈谈你对MyBatis的理解 <a class="header-anchor" href="#_14-谈谈你对mybatis的理解" aria-label="Permalink to &quot;14.谈谈你对MyBatis的理解&quot;">​</a></h1><h2 id="_14-1-mybatis的基本介绍" tabindex="-1">14.1 MyBatis的基本介绍 <a class="header-anchor" href="#_14-1-mybatis的基本介绍" aria-label="Permalink to &quot;14.1 MyBatis的基本介绍&quot;">​</a></h2><p>MyBatis是一种持久层框架的 <code>ORM</code>框架，用于在Java应用程序中与关系型数据库进行交互。它提供了一种简单且灵活的方式来处理数据库操作，同时也允许开发人员使用原生的SQL语句。</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/eacd498cebad462ba8158c63f2f22ce4.png" alt="image.png" loading="lazy"></p><p>具有如下的相关的特点：</p><ol><li>易于配置和使用：MyBatis使用XML或注解配置数据库操作，使得配置和使用变得简单而直观。开发人员只需要定义SQL语句和参数映射，MyBatis就能够自动执行这些操作。</li><li>灵活的SQL编写：相比其他ORM框架，MyBatis更加灵活，允许开发人员直接编写原生SQL语句。这使得开发人员可以更好地优化查询，处理复杂的数据库操作，并且可以使用数据库特定的功能。</li><li>提供了对象关系映射（ORM）功能：MyBatis可以将查询结果映射到Java对象上，简化了数据的处理和操作。开发人员只需要定义对象与数据库表之间的映射关系，MyBatis就能够自动将查询结果转换为Java对象。</li><li>支持动态SQL：MyBatis支持动态SQL语句的构建，可以根据不同的条件生成不同的SQL语句。这使得开发人员可以根据实际情况构建灵活的查询条件，提高了查询的效率和灵活性。</li></ol><p>MyBatis和JDBC哪个性能效率高？</p><h2 id="_14-2-mybaits的架构设计" tabindex="-1">14.2 MyBaits的架构设计 <a class="header-anchor" href="#_14-2-mybaits的架构设计" aria-label="Permalink to &quot;14.2 MyBaits的架构设计&quot;">​</a></h2><p>MyBatis的整体架构非常简洁，分别是：接口层，核心处理层和基础模块：</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/04a54ebd53df4b1dbed6622e92957da6.png" alt="image.png" loading="lazy"></p><h2 id="_14-3-和mybatisplus的关系" tabindex="-1">14.3 和MyBatisPlus的关系 <a class="header-anchor" href="#_14-3-和mybatisplus的关系" aria-label="Permalink to &quot;14.3 和MyBatisPlus的关系&quot;">​</a></h2><p>MyBatisPlus是当下持久层中使用频率非常高的一个开源框架。和MyBatis的对比就非常多，这块也可以介绍下：</p><ol><li>MyBatis是一个开源的持久层框架，它提供了简单的SQL映射和灵活的结果集映射功能，可以方便地与各种数据库进行交互。MyBatis通过XML文件或注解方式配置SQL语句和映射关系。</li><li>MyBatis Plus是在MyBatis基础上进行了扩展的框架，它提供了更多的便捷功能和增强特性，使得开发人员能够更快速地进行数据库操作。MyBatis Plus提供了一些常用的CRUD方法，简化了开发过程，并支持更复杂的条件查询和分页功能。</li><li>MyBatis Plus是基于MyBatis的，它使用了MyBatis的核心功能，同时扩展了更多的功能。因此，可以说MyBatis Plus是MyBatis的增强版。</li></ol><p>总的来说，MyBatis是一个轻量级的持久层框架，而MyBatis Plus是在MyBatis基础上进行了扩展，提供了更多的便捷功能和增强特性.</p><h1 id="_15-谈谈mybatis的启动过程" tabindex="-1">15.谈谈MyBatis的启动过程 <a class="header-anchor" href="#_15-谈谈mybatis的启动过程" aria-label="Permalink to &quot;15.谈谈MyBatis的启动过程&quot;">​</a></h1><p>这个题目的主要目的是考察大家对MyBatis的理解深度，如果单纯的是做 <code>CRUD</code>的开发，可能就忽略了。首先我们需要介绍清楚MyBatis执行启动的操作代码</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Test</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() throws Exception{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1. 加载全局配置文件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    InputStream in </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Resources.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getResourceAsStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mybatis-config.xml&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2.获取SqlSessionFactory</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // DefaultSqlSessionFactory</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    SqlSessionFactory factory </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SqlSessionFactoryBuilder</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">build</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(in);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3.获取SqlSession对象 DefaultSqlSession  Executor--&gt; SimpleExecutor --&gt; CachingExecutor --&gt; 插件的逻辑植入</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    SqlSession sqlSession </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> factory.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">openSession</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4.通过sqlSession的API接口实现数据库操作</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sqlSession.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">selectList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;com.bobo.vip.mapper.UserMapper.selectUserById&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (User user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> list) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        System.out.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 关闭会话</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sqlSession.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>具体的操作过程如下：</p><ol><li>加载配置文件：MyBatis的配置文件是一个XML文件，包含了数据库连接信息、映射文件的位置等配置信息。在启动过程中，MyBatis会读取并解析这个配置文件。</li><li>创建SqlSessionFactory对象：SqlSessionFactory是MyBatis的核心对象，用于创建SqlSession对象。在启动过程中，MyBatis会根据配置文件中的信息，创建一个SqlSessionFactory对象。</li><li>创建SqlSession对象：SqlSession是MyBatis的会话对象，用于执行数据库操作。在启动过程中，MyBatis会根据SqlSessionFactory对象，创建一个SqlSession对象。</li><li>加载映射文件：映射文件是MyBatis的另一个重要配置，用于定义SQL语句与Java方法之间的映射关系。在启动过程中，MyBatis会根据配置文件中的信息，加载映射文件。</li><li>初始化Mapper接口：Mapper接口是用于执行SQL语句的Java接口，在启动过程中，MyBatis会根据映射文件中的信息，动态生成Mapper接口的实现类。</li><li>完成启动：启动过程完成后，就可以使用SqlSession对象执行数据库操作了。</li></ol><p>当然这块的过程相对还是比较简单的。面试官可能会在这个基础上做相关的扩展。可以结合下面的图分析</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/9ae8167b3e6a40e4b52c418d4dc9c806.png" alt="image.png" loading="lazy"></p><p>也就是 <code>SqlSessionFactory</code>对象的构建和 <code>SqlSession</code>对象创建的核心过程。已经具体的数据库操作的请求是如何实现的。这块也是面试官比较感兴趣的内容。</p><ul><li>SqlSessionFactory：全局配置文件的加载解析和映射文件的加载解析</li><li>SqlSession：相关的核心Executor和拦截器的实例化</li><li>Executor：处理具体的请求涉及到缓存处理。分页扩展以及Sql解析和参数解析等</li></ul><h1 id="_16-谈谈mybatis中的缓存设计" tabindex="-1">16.谈谈MyBatis中的缓存设计 <a class="header-anchor" href="#_16-谈谈mybatis中的缓存设计" aria-label="Permalink to &quot;16.谈谈MyBatis中的缓存设计&quot;">​</a></h1><h2 id="_16-1-缓存的作用" tabindex="-1">16.1 缓存的作用 <a class="header-anchor" href="#_16-1-缓存的作用" aria-label="Permalink to &quot;16.1 缓存的作用&quot;">​</a></h2><p>MyBatis缓存的作用是提高数据库访问性能。它将查询结果缓存到内存中，当下次有相同的查询请求时，直接从缓存中取出结果，避免了再次访问数据库，从而提高了查询的响应速度。</p><h2 id="_16-2-一级缓存" tabindex="-1">16.2 一级缓存 <a class="header-anchor" href="#_16-2-一级缓存" aria-label="Permalink to &quot;16.2 一级缓存&quot;">​</a></h2><p>一级缓存是SqlSession级别的缓存，它默认是开启的。当同一个SqlSession执行相同的SQL语句时，会先从缓存中查找，如果找到了对应的结果，则直接返回缓存中的结果，而不会再次访问数据库。</p><p>要关闭一级缓存：</p><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">setting</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;localCacheScope&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;STATEMENT&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/&gt;</span></span></code></pre></div><h2 id="_16-3-二级缓存" tabindex="-1">16.3 二级缓存 <a class="header-anchor" href="#_16-3-二级缓存" aria-label="Permalink to &quot;16.3 二级缓存&quot;">​</a></h2><p>二级缓存是Mapper级别的缓存，它默认是关闭的。当不同的SqlSession执行相同的SQL语句时，如果开启了二级缓存，则会先从缓存中查找，如果找到了对应的结果，则直接返回缓存中的结果，而不会再次访问数据库。</p><p>要开启二级缓存：</p><p>首先是在全局配置文件中设置：</p><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- 控制全局缓存（二级缓存），默认 true--&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">setting</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cacheEnabled&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;true&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/&gt;</span></span></code></pre></div><p>然后需要在具体的映射文件中设置 <code>cache</code>标签</p><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">cache</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!--&lt;cache type=&quot;org.mybatis.caches.redis.RedisCache&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       eviction=&quot;FIFO&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       flushInterval=&quot;60000&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       size=&quot;512&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       readOnly=&quot;true&quot;/&gt;--&gt;</span></span></code></pre></div><p>如果映射文件中的某个方法不想开启缓存可以设置 <code>useCache=&quot;false&quot;</code>处理</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/bd68bd23e4a8420eacf02e26457b8ecb.png" alt="image.png" loading="lazy"></p><p>当我们开启了二级缓存后。查询操作是先走二级缓存还是先走一级缓存？</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/1c872d35f6704fb4ae8a20888ec6c359.png" alt="image.png" loading="lazy"></p><h2 id="_16-4-三级缓存" tabindex="-1">16.4 三级缓存 <a class="header-anchor" href="#_16-4-三级缓存" aria-label="Permalink to &quot;16.4 三级缓存&quot;">​</a></h2><p>三级缓存是在分布式环境下把存储在内存中的数据持久化到第三方数据源的过程。比如Redis中。这块需要重写 <code>Cache</code>接口</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/d962be4bdbfe42b29f15a4c63918d6b4.png" alt="image.png" loading="lazy"></p><h1 id="_17-mybatis中的拦截器的理解" tabindex="-1">17.MyBatis中的拦截器的理解 <a class="header-anchor" href="#_17-mybatis中的拦截器的理解" aria-label="Permalink to &quot;17.MyBatis中的拦截器的理解&quot;">​</a></h1><h2 id="_17-1-拦截器的定义" tabindex="-1">17.1 拦截器的定义 <a class="header-anchor" href="#_17-1-拦截器的定义" aria-label="Permalink to &quot;17.1 拦截器的定义&quot;">​</a></h2><p>MyBatis 允许你在映射语句执行过程中的某一点进行拦截调用。默认情况下，MyBatis 允许使用插件来拦截的方法调用包括： <a href="https://mybatis.net.cn/configuration.html#plugins" target="_blank" rel="noreferrer">https://mybatis.net.cn/configuration.html#plugins</a></p><ul><li>Executor(update, query, flushStatements, commit, rollback, getTransaction, close, isClosed)</li><li>ParameterHandler(getParameterObject, setParameters)</li><li>ResultSetHandler(handleResultSets, handleOutputParameters)</li><li>StatementHandler(prepare, parameterize, batch, update, query)</li></ul><h2 id="_17-2-拦截器的应用" tabindex="-1">17.2 拦截器的应用 <a class="header-anchor" href="#_17-2-拦截器的应用" aria-label="Permalink to &quot;17.2 拦截器的应用&quot;">​</a></h2><p>MyBatis拦截器是MyBatis提供的一种插件机制，可以在SQL执行过程中拦截SQL语句并进行相关操作。</p><p>拦截器可以用于实现一些通用的功能，如日志记录、权限校验、性能监控等。它可以拦截SQL的执行、参数的设置、结果的处理等环节。</p><p>要实现一个拦截器，需要实现MyBatis提供的Interceptor接口，并重写其中的方法。Interceptor接口中定义了3个方法：</p><ol><li>intercept：拦截方法，用于在SQL执行前后进行一些操作。在该方法中可以通过Invocation.proceed()方法调用下一个拦截器或执行目标方法。</li><li>plugin：用于包装目标对象，返回一个代理对象。可以通过该方法为目标对象生成一个代理对象，以便拦截对目标对象的方法调用。</li><li>setProperties：用于设置拦截器的属性。可以通过该方法获取配置文件中的属性，并进行相应的初始化操作。</li></ol><p>拦截器在MyBatis的配置文件中进行配置，可以通过<code>&lt;plugins&gt;</code> 标签将拦截器添加到MyBatis的拦截链中。</p><p>使用拦截器可以方便地扩展MyBatis的功能，实现一些通用的需求，并且可以灵活地控制拦截器的顺序。</p><p>使用的步骤：</p><p>先定义</p><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ExamplePlugin.java</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Intercepts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Signature</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Executor.class,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  method</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;update&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  args</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {MappedStatement.class,Object.class})})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ExamplePlugin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Interceptor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Properties properties </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Properties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Object </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">intercept</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Invocation </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">invocation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">throws</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Throwable {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // implement pre processing if need</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Object returnObject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> invocation.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">proceed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // implement post processing if need</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> returnObject;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> setProperties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Properties </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">properties</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.properties </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> properties;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>再注册</p><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- mybatis-config.xml --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">plugins</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">plugin</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> interceptor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;org.mybatis.example.ExamplePlugin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">property</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;someProperty&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;100&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">plugin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">plugins</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><p>上面的插件将会拦截在 Executor 实例中所有的 “update” 方法调用， 这里的 Executor 是负责执行底层映射语句的内部对象。</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/897aeeaab50045a485a091b5a3c2192d.png" alt="image.png" loading="lazy"></p><p>实际的应用：分页，SQL检查。黑白名单。分库分表等</p><h1 id="_18-sqlsession有数据安全问题" tabindex="-1">18.SqlSession有数据安全问题? <a class="header-anchor" href="#_18-sqlsession有数据安全问题" aria-label="Permalink to &quot;18.SqlSession有数据安全问题?&quot;">​</a></h1><h2 id="_18-1-sqlsession为什么是数据不安全的" tabindex="-1">18.1 SqlSession为什么是数据不安全的？ <a class="header-anchor" href="#_18-1-sqlsession为什么是数据不安全的" aria-label="Permalink to &quot;18.1 SqlSession为什么是数据不安全的？&quot;">​</a></h2><p>在MyBatis中，SqlSession是一个线程不安全的对象，主要原因如下：</p><ol><li>SqlSession的底层实现是基于JDBC的Connection对象，而Connection对象是非线程安全的，因此SqlSession也是非线程安全的。</li><li>SqlSession中包含了数据库连接和事务相关的操作，如果多个线程共享同一个SqlSession实例，可能会导致数据的 <code>不一致性</code>或者 <code>事务的混乱</code>。</li><li>SqlSession中的 <code>缓存机制</code>也是基于当前线程的，如果多个线程共享同一个SqlSession实例，可能会导致缓存的数据混乱或者不一致。</li></ol><h2 id="_18-2-如何解决这个问题" tabindex="-1">18.2 如何解决这个问题？ <a class="header-anchor" href="#_18-2-如何解决这个问题" aria-label="Permalink to &quot;18.2 如何解决这个问题？&quot;">​</a></h2><p>为了保证数据的安全性和一致性，通常建议在每个线程中使用独立的SqlSession实例，可以通过工厂模式创建新的SqlSession对象，或者使用MyBatis提供的线程安全的SqlSessionFactory实例来创建SqlSession。另外，可以使用ThreadLocal来保证每个线程中使用的SqlSession对象是唯一的。</p><h2 id="_18-3-spring整合mybatis的解决方案" tabindex="-1">18.3 Spring整合MyBatis的解决方案 <a class="header-anchor" href="#_18-3-spring整合mybatis的解决方案" aria-label="Permalink to &quot;18.3 Spring整合MyBatis的解决方案&quot;">​</a></h2><p><a href="https://dpb-bobokaoya-sm.blog.csdn.net/article/details/117415102" target="_blank" rel="noreferrer">https://dpb-bobokaoya-sm.blog.csdn.net/article/details/117415102</a></p><p>在Spring中，可以通过使用 <code>SqlSessionTemplate</code>来解决SqlSession数据不安全的问题。<code>SqlSessionTemplate</code>是MyBatis-Spring提供的一个实现了 <code>SqlSession</code>接口的类，它会自动管理SqlSession的生命周期，并保证每个线程都有自己的SqlSession实例。使用 <code>SqlSessionTemplate</code>时，只需要将其配置为Spring的Bean，并注入到需要使用SqlSession的地方即可，Spring会自动为每个线程提供一个独立的SqlSession实例。</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/9e8293948e0247fa956bffd07a29f4c9.png" alt="image.png" loading="lazy"></p><h1 id="_19-一个xml都会对应一个mapper接口。这个mapper接口的工作原理是什么" tabindex="-1">19.一个xml都会对应一个Mapper接口。这个Mapper接口的工作原理是什么？ <a class="header-anchor" href="#_19-一个xml都会对应一个mapper接口。这个mapper接口的工作原理是什么" aria-label="Permalink to &quot;19.一个xml都会对应一个Mapper接口。这个Mapper接口的工作原理是什么？&quot;">​</a></h1><p>我们在定义的时候需要满足相关的规则： User.xml User.java</p><p>User proxy = SqlSessin.getMapper(User.class);</p><ol><li>接口名称和xml文件的名称要一致</li><li>接口中定义的方法需要在xml有同名的标签id</li><li>xml中的namespace必须是接口的全限定名</li></ol><p>在执行的时候我们会调用SqlSession的getMapper方法。通过getMapper方法来获取接口的代理对象。执行相关操作的时候会通过代理对象的invoke 方法来找到对应的SQL执行。并返回结果。</p><h1 id="_20-上个问题中的方法能重载吗" tabindex="-1">20.上个问题中的方法能重载吗？ <a class="header-anchor" href="#_20-上个问题中的方法能重载吗" aria-label="Permalink to &quot;20.上个问题中的方法能重载吗？&quot;">​</a></h1><div class="language-java vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">User proxy </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SqlSessin.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getMapper</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(User.class);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">proxy.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">insertUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user); </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">--&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">insert id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;insertUser&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  &gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">insert ....</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">insert</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>不可以。因为根据接口中的方法来获取对应的xml中的标签是通过 全限定名+方法名的方式来获取的。如果重载会找到多个。</p><h1 id="_21-mybatis是否支持延迟加载-如果支持原理是什么呢" tabindex="-1">21. MyBatis是否支持延迟加载？如果支持原理是什么呢？ <a class="header-anchor" href="#_21-mybatis是否支持延迟加载-如果支持原理是什么呢" aria-label="Permalink to &quot;21. MyBatis是否支持延迟加载？如果支持原理是什么呢？&quot;">​</a></h1><p>Mybatis 仅支持 association 关联对象和 collection 关联集合对象的延迟加载，association 指的就是一对一，collection 指的就是一对多查询。在 Mybatis 配置文件中，可以配置是否启用延迟加载 lazyLoadingEnabled=true|false。</p><p>它的原理是，使用 CGLIB 创建目标对象的代理对象，当调用目标方法时，进入拦截器方法，比如调用 a.getB().getName()，拦截器 invoke()方法发现 a.getB()是 null值，那么就会单独发送事先保存好的查询关联 B 对象的 sql，把 B 查询上来，然后调用 a.setB(b)，于是 a 的对象 b 属性就有值了，接着完成 a.getB().getName()方法的调用。这就是延迟加载的基本原理。</p><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/c99e525b5afb401dbb3eb888ccde07fc.png" alt="image.png" loading="lazy"></p><h1 id="_22-mybatis中是如何记录jdbc相关的日志的" tabindex="-1">22.MyBatis中是如何记录JDBC相关的日志的？ <a class="header-anchor" href="#_22-mybatis中是如何记录jdbc相关的日志的" aria-label="Permalink to &quot;22.MyBatis中是如何记录JDBC相关的日志的？&quot;">​</a></h1><p>日志模块中提供了一个jdbc模块。通过代理的方式记录相关的操作日志信息。</p><h1 id="_23-mybatis的数据源模块是怎么设计的" tabindex="-1">23.MyBatis的数据源模块是怎么设计的？ <a class="header-anchor" href="#_23-mybatis的数据源模块是怎么设计的" aria-label="Permalink to &quot;23.MyBatis的数据源模块是怎么设计的？&quot;">​</a></h1><p>提供了两种方式：</p><ol><li>非连接池的方式</li><li>连接池的方式</li></ol><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/0ddb75d55ee341ab8dfab8c1c1ea4dc2.png" alt="image.png" loading="lazy"></p><h1 id="_24-mybatis中是如何处理事务的" tabindex="-1">24.MyBatis中是如何处理事务的？ <a class="header-anchor" href="#_24-mybatis中是如何处理事务的" aria-label="Permalink to &quot;24.MyBatis中是如何处理事务的？&quot;">​</a></h1><ol><li>JDBC处理</li><li>Managed：交给当前的WEB容器处理</li></ol><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/1462/1695626417057/d059ea4db93c477ea5d03c0669c117e2.png" alt="image.png" loading="lazy"></p><h1 id="_25-1000w条数据如何高效的插入到数据库中" tabindex="-1">25.1000W条数据如何高效的插入到数据库中 <a class="header-anchor" href="#_25-1000w条数据如何高效的插入到数据库中" aria-label="Permalink to &quot;25.1000W条数据如何高效的插入到数据库中&quot;">​</a></h1><p>从文件中读取：从哪来的？</p><ol><li>估算文件大小：根据每条记录的字段信息。最直观的把这1000w写入文件中查看大小</li><li>如何批量插入:文件比较大的情况下。需要分批次的处理 insert into()values(),,,,,,</li><li>数据完整性:1000W的数据来源我们需要保存每条数据都是完整的</li><li>数据库是否支持批次数据：mysql（max_allowed_packet）</li><li>中途出错的问题：如果中途出现错误，比如数据刚好插入到900w的时候，数据库连接失败，这种情况不可能重新来插一遍，所有需要记录每次插入数据的位置，并且需要保证和批次插入的数据在同一个事务中，这样恢复之后可以从记录的位置开始继续插入</li></ol><h1 id="_26-项目中你们是怎么处理异常的" tabindex="-1">26.项目中你们是怎么处理异常的？ <a class="header-anchor" href="#_26-项目中你们是怎么处理异常的" aria-label="Permalink to &quot;26.项目中你们是怎么处理异常的？&quot;">​</a></h1><p>在我们的项目中，我们采用以下方式实现异常的统一处理：</p><ol><li>异常捕获：在代码的关键位置，使用try-catch语句捕获可能发生的异常。</li><li>异常分类：根据异常的类型进行分类，例如业务异常、系统异常等。</li><li>统一封装：针对不同类型的异常，我们会封装统一的异常类，例如BusinessException、SystemException等，这些异常类继承自通用的Exception类。</li><li>异常处理器：在项目中定义一个全局的异常处理器，用于捕获和处理所有未被try-catch语句捕获的异常。</li><li>异常处理逻辑：在异常处理器中，我们会根据异常的类型进行相应的处理逻辑，例如记录异常日志、返回友好的错误信息等。</li><li>统一返回结果：无论是业务异常还是系统异常，我们都会将异常信息封装成统一的返回结果对象，用于给前端或其他调用方返回异常信息。</li><li>异常信息国际化：为了支持多语言环境，我们会将异常信息进行国际化处理，根据请求的语言环境返回相应的异常信息。</li></ol><p>通过以上的方式，我们能够实现异常的统一处理，提高代码的可维护性和可读性，并且能够更好地进行日志记录和错误信息返回。</p>`,259),p=[l];function h(e,k,r,E,d,g){return a(),i("div",null,p)}const c=s(t,[["render",h]]);export{y as __pageData,c as default};
